import { NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { getCache, CachedItem, keywordMap } from '@/lib/searchCache';

// Kh·ªüi t·∫°o Gemini AI
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY! || 'AIzaSyAT4nqOpNNJrP8FoZ00dwqQWYcolh0AkzQ');

// Interface cho intent ƒë∆∞·ª£c ph√¢n t√≠ch
interface ParsedIntent {
  intent: string;
  entity: string;
  extra: {
    storage: string;
    color: string;
    priceRange: string;
    feature: string;
  };
}

// H√†m chu·∫©n h√≥a chu·ªói ƒë·ªÉ kh·ªõp
function normalizeString(str: string): string {
  return str.toLowerCase().replace(/[^a-z0-9]/g, '');
}

// H√†m ki·ªÉm tra query c√≥ kh·ªõp v·ªõi t√™n s·∫£n ph·∫©m, h·ªó tr·ª£ ƒëa t·ª´ v√† vi·∫øt t·∫Øt
function queryMatchesName(query: string, name: string): boolean {
  const qTokens = query
    .toLowerCase()
    .split(/\s+/)
    .map((w) => keywordMap[w] || w)
    .map(normalizeString)
    .filter(Boolean);

  const normalizedName = normalizeString(name);
  return qTokens.every((token) => normalizedName.includes(token));
}

// H√†m tr√≠ch xu·∫•t entities b·∫±ng regex, h·ªó tr·ª£ bi·∫øn th·ªÉ v√† vi·∫øt t·∫Øt
function extractEntities(text: string): string[] {
  const lower = text.toLowerCase();
  const regex =
    /\b(iphone|samsung|macbook|ipad|windows|a36|s25)\s?(\d{1,2})?\s?(pro\s?max|promax|pro|plus|air|mini|ultra|fold|flip)?\s?(\d{2,3}gb)?\s?(xanh|ƒëen|tr·∫Øng|v√†ng|b·∫°c|ƒë·ªè)?\b/gi;
  const matches = lower.match(regex);
  return matches
    ? [...new Set(matches.map((m) => keywordMap[m.trim()] || m.trim()))] // √Åp d·ª•ng √°nh x·∫° alias
    : [];
}

// H√†m l·ªçc s·∫£n ph·∫©m d·ª±a tr√™n entities v√† tham s·ªë extra
function filterProducts(cachedData: CachedItem[], entities: string[], extra: ParsedIntent['extra'], intent: string = ''): CachedItem[] {
  let filtered = cachedData;

  if (entities.length > 0) {
    filtered = filtered.filter((item) => entities.some((term) => queryMatchesName(term, item.name)));
  }

  if (extra.storage) {
    const storageLower = extra.storage.toLowerCase();
    filtered = filtered.filter((item) => item.name.toLowerCase().includes(storageLower));
  }

  if (extra.color) {
    const colorLower = extra.color.toLowerCase();
    filtered = filtered.filter((item) => item.color?.toLowerCase().includes(colorLower));
  }

  if (extra.priceRange || intent === 'cheapest_product' || intent === 'filter_by_price') {
    const range = extra.priceRange.toLowerCase();
    if (range.includes('d∆∞·ªõi') || range.includes('under')) {
      const maxPrice = parseInt(range.match(/\d+/)?.[0] || '0') * 1000000;
      filtered = filtered.filter((item) => (item.price || Infinity) * 1000 <= maxPrice);
    } else if (range.includes('r·∫ª nh·∫•t') || range.includes('cheapest') || intent === 'cheapest_product') {
      filtered.sort((a, b) => (a.price || Infinity) - (b.price || Infinity));
      filtered = filtered.slice(0, 5);
    }
    // Th√™m logic kho·∫£ng gi√° kh√°c n·∫øu c·∫ßn, v√≠ d·ª•: 't·ª´ X-Y tri·ªáu'
  }

  if (extra.feature || intent === 'filter_by_feature') {
    const featureLower = extra.feature.toLowerCase();
    filtered = filtered.filter((item) => item.name.toLowerCase().includes(featureLower));
  }

  return Array.from(new Map(filtered.map((p) => [p._id, p])).values()).slice(0, 10);
}

// H√†m t·∫°o th·∫ª HTML card cho s·∫£n ph·∫©m
function generateCardsFromResults(products: CachedItem[]): string {
  if (!products.length) return '';

  return `
     <div class="w-full">
        <!-- Title -->
        <span>Ch√∫ng t√¥i c√≥ m·ªôt s·ªë s·∫£n ph·∫©m li√™n quan:</span>
        <!-- Products grid -->
        <div class="grid grid-cols-2  gap-2">
         ${products
           .map(
             (product) => `
             <a href="${product.link}">
               <div class="bg-white border border-gray-200 rounded-md m p-1 flex flex-col items-center text-start transition">
               <img src="${product.image}" alt="${product.name}" class="w-20 h-20 object-contain mb-3 rounded-md bg-white">
               <div class="w-full">
                   <p class="text-gray-800 font-medium text-xs">${product.name}</p>
                   <p class="text-gray-500 text-xs mb-1">M√†u: ${product.color || 'N/A'}</p>
                   <p class="text-price font-semibold text-sm">${((product.price || 0) * 1000).toLocaleString('vi-VN')} VNƒê</p>
                   <span class="text-primary text-xs font-medium hover:underline">Xem chi ti·∫øt</span>
                 </div>
                 </div>
             </a>
             `
           )
           .join('')}
       </div>
      </div>

  `;
}

// C√°c ph·∫£n h·ªìi hardcoded cho smalltalk
const smalltalkResponses: Record<string, string> = {
  // Ch√†o h·ªèi
  'xin ch√†o': 'Xin ch√†o Anh/Ch·ªã! Em l√† tr·ª£ l√Ω AI c·ªßa 7Teck. Anh/Ch·ªã ƒëang t√¨m s·∫£n ph·∫©m n√†o h√¥m nay? ƒêi·ªán tho·∫°i, laptop hay m√°y t√≠nh b·∫£ng?',
  hello: 'Em r·∫•t s·∫µn l√≤ng h·ªó tr·ª£ Anh/Ch·ªã üòä. Anh/Ch·ªã c·∫ßn t∆∞ v·∫•n s·∫£n ph·∫©m g√¨?',
  hi: 'Hi! Em l√† tr·ª£ l√Ω b√°n h√†ng c·ªßa 7Teck.vn. H√£y cho em bi·∫øt Anh/Ch·ªã quan t√¢m ƒë·∫øn iPhone, Samsung hay MacBook nh√©!',
  'ch√†o shop': 'D·∫° em ch√†o Anh/Ch·ªã ·∫° üëã. Em c√≥ th·ªÉ h·ªó tr·ª£ Anh/Ch·ªã t√¨m s·∫£n ph·∫©m nhanh ch√≥ng nh·∫•t.',
  alo: 'D·∫° em nghe ·∫° üòÑ. Anh/Ch·ªã mu·ªën tham kh·∫£o d√≤ng s·∫£n ph·∫©m n√†o c·ªßa 7Teck?',
  'good morning': 'Good morning Anh/Ch·ªã üåû. Anh/Ch·ªã c·∫ßn tham kh·∫£o s·∫£n ph·∫©m n√†o cho h√¥m nay?',
  'good evening': 'Ch√†o bu·ªïi t·ªëi Anh/Ch·ªã üåô. Anh/Ch·ªã mu·ªën em t∆∞ v·∫•n ƒëi·ªán tho·∫°i, laptop hay ph·ª• ki·ªán ·∫°?',

  // C·∫£m ∆°n
  'c·∫£m ∆°n': 'D·∫° em c·∫£m ∆°n Anh/Ch·ªã ƒë√£ tin t∆∞·ªüng 7Teck ·∫° üôè. N·∫øu c·∫ßn th√™m h·ªó tr·ª£, em lu√¥n s·∫µn s√†ng.',
  thanks: 'You‚Äôre welcome Anh/Ch·ªã! Em lu√¥n s·∫µn l√≤ng h·ªó tr·ª£ ·∫° üòä.',
  'thank you': 'R·∫•t vui ƒë∆∞·ª£c h·ªó tr·ª£ Anh/Ch·ªã üíô. N·∫øu c√≤n th·∫Øc m·∫Øc, Anh/Ch·ªã c·ª© h·ªèi em nh√©!',

  // H·ªèi thƒÉm
  'kh·ªèe kh√¥ng': 'D·∫° em lu√¥n s·∫µn s√†ng ƒë·ªÉ ph·ª•c v·ª• Anh/Ch·ªã ·∫° üí™. Anh/Ch·ªã th√¨ sao ·∫°?',
  'how are you': 'I‚Äôm great, thank you! üòä S·∫µn s√†ng t∆∞ v·∫•n cho Anh/Ch·ªã b·∫•t k·ª≥ s·∫£n ph·∫©m n√†o ·ªü 7Teck.',

  // T·∫°m bi·ªát
  't·∫°m bi·ªát': 'D·∫° em ch√†o Anh/Ch·ªã üëã. H·∫πn g·∫∑p l·∫°i Anh/Ch·ªã t·∫°i 7Teck.vn nh√©!',
  bye: 'Bye Anh/Ch·ªã, ch√∫c Anh/Ch·ªã m·ªôt ng√†y t·ªët l√†nh üåü.',
  'see you': 'See you again soon, Anh/Ch·ªã! Em lu√¥n ·ªü ƒë√¢y h·ªó tr·ª£ ·∫°.',

  // C√°c c√¢u ph·ªï bi·∫øn kh√°c
  '7teck l√† g√¨':
    '7Teck l√† h·ªá th·ªëng b√°n l·∫ª c√°c s·∫£n ph·∫©m c√¥ng ngh·ªá ch√≠nh h√£ng: ƒëi·ªán tho·∫°i, laptop, tablet v√† ph·ª• ki·ªán. Anh/Ch·ªã c·∫ßn em gi·ªõi thi·ªáu danh m·ª•c n√†o ·∫°?',
  'c√≥ freeship kh√¥ng': 'D·∫°, 7Teck c√≥ h·ªó tr·ª£ freeship cho ƒë∆°n h√†ng ƒë·ªß ƒëi·ªÅu ki·ªán üéÅ. Anh/Ch·ªã mu·ªën em ki·ªÉm tra chi ti·∫øt gi√∫p kh√¥ng ·∫°?',
  'gi·ªù m·ªü c·ª≠a': '7Teck.vn h·ªó tr·ª£ online 24/7. N·∫øu Anh/Ch·ªã c·∫ßn ƒë·∫øn c·ª≠a h√†ng, gi·ªù m·ªü c·ª≠a l√† 8:00 - 21:30 h·∫±ng ng√†y.',
};

export async function POST(req: Request) {
  try {
    const body = (await req.json()) as { message: string };
    const { message } = body;
    if (!message) {
      return NextResponse.json({ success: false, message: 'Thi·∫øu tin nh·∫Øn' }, { status: 400 });
    }

    if (!process.env.GEMINI_API_KEY) {
      return NextResponse.json({ success: false, message: 'Ch∆∞a c·∫•u h√¨nh API key cho Gemini.' }, { status: 500 });
    }

    const lowerMessage = message.toLowerCase();

    // 1. Ki·ªÉm tra smalltalk hardcoded ƒë·ªÉ ti·∫øt ki·ªám quota
    for (const key in smalltalkResponses) {
      if (lowerMessage.includes(key)) {
        console.log('[DEBUG] Tr·∫£ l·ªùi t·ª´ smalltalk hardcoded (kh√¥ng t·ª´ DB ho·∫∑c AI).');
        return NextResponse.json({
          success: true,
          reply: smalltalkResponses[key],
          intent: 'smalltalk',
          entity: '',
          productsFound: 0,
          source: 'smalltalk', // Th√™m field debug source
        });
      }
    }

    // 2. Tr√≠ch xu·∫•t entities v√† x·ª≠ l√Ω alias
    let entities = extractEntities(message);

    // 3. T·∫£i cache v√† t√¨m ki·∫øm tr·ª±c ti·∫øp t·ª´ DB
    const cachedData = await getCache();
    let foundProducts = filterProducts(cachedData, entities, { storage: '', color: '', priceRange: '', feature: '' });

    // 4. N·∫øu t√¨m th·∫•y s·∫£n ph·∫©m t·ª´ DB, render card v√† tr·∫£ v·ªÅ m√† kh√¥ng g·ªçi AI
    if (foundProducts.length > 0) {
      console.log(`[DEBUG] L·∫•y d·ªØ li·ªáu t·ª´ DB: T√¨m th·∫•y ${foundProducts.length} s·∫£n ph·∫©m. Kh√¥ng g·ªçi AI.`);
      const reply = generateCardsFromResults(foundProducts);
      return NextResponse.json({
        success: true,
        reply,
        intent: 'search_product',
        entity: entities.join(', '),
        productsFound: foundProducts.length,
        source: 'db', // Th√™m field debug source
      });
    }

    // 5. Fallback ƒë·∫øn Gemini ƒë·ªÉ ph√¢n t√≠ch intent (ch·ªâ khi kh√¥ng match DB)
    console.log('[DEBUG] Kh√¥ng t√¨m th·∫•y t·ª´ DB, fallback g·ªçi AI (Gemini) ƒë·ªÉ ph√¢n t√≠ch intent.');
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash-latest' });
    const intentPrompt = `
    B·∫°n l√† h·ªá th·ªëng NLP th√¥ng minh cho chatbot b√°n h√†ng ƒëi·ªán tho·∫°i, laptop, m√°y t√≠nh b·∫£ng t·∫°i 7Teck.vn.
    Ph√¢n t√≠ch tin nh·∫Øn ng∆∞·ªùi d√πng: "${message}".
    
    Tr·∫£ v·ªÅ JSON ch√≠nh x√°c v·ªõi c·∫•u tr√∫c sau (kh√¥ng th√™m g√¨ ngo√†i JSON):
    {
      "intent": "ask_price" | "search_product" | "ask_color" | "ask_payment" | "ask_availability" | "smalltalk" | "compare_products" | "cheapest_product" | "filter_by_price" | "filter_by_feature" | "other",
      "entity": "t√™n s·∫£n ph·∫©m ho·∫∑c t·ª´ kh√≥a ch√≠nh (v√≠ d·ª•: iphone 14, samsung s23, macbook air). N·∫øu nhi·ªÅu, ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y. N·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ tr·ªëng",
      "extra": {
        "storage": "dung l∆∞·ª£ng l∆∞u tr·ªØ (v√≠ d·ª•: 128GB, 256GB). N·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ tr·ªëng",
        "color": "m√†u s·∫Øc (v√≠ d·ª•: xanh, ƒëen). N·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ tr·ªëng",
        "priceRange": "kho·∫£ng gi√° (v√≠ d·ª•: d∆∞·ªõi 10 tri·ªáu, t·ª´ 15-20 tri·ªáu, r·∫ª nh·∫•t). N·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ tr·ªëng",
        "feature": "t√≠nh nƒÉng c·ª• th·ªÉ (v√≠ d·ª•: camera t·ªët, pin l√¢u, gaming, m√†n h√¨nh l·ªõn). N·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ tr·ªëng"
      }
    }
    
    Quy t·∫Øc ph√¢n lo·∫°i intent:
    - H·ªèi gi√° s·∫£n ph·∫©m: "ask_price"
    - T√¨m ki·∫øm ho·∫∑c h·ªèi v·ªÅ s·∫£n ph·∫©m c·ª• th·ªÉ: "search_product"
    - H·ªèi v·ªÅ m√†u s·∫Øc c√≥ s·∫µn: "ask_color"
    - H·ªèi v·ªÅ tr·∫£ g√≥p, thanh to√°n: "ask_payment"
    - H·ªèi c√≤n h√†ng, t·ªìn kho: "ask_availability"
    - Ch√†o h·ªèi, tr√≤ chuy·ªán x√£ giao: "smalltalk"
    - So s√°nh gi·ªØa c√°c s·∫£n ph·∫©m: "compare_products"
    - T√¨m s·∫£n ph·∫©m r·∫ª nh·∫•t trong lo·∫°i: "cheapest_product"
    - L·ªçc theo kho·∫£ng gi√°: "filter_by_price"
    - L·ªçc theo t√≠nh nƒÉng: "filter_by_feature"
    - Kh√¥ng kh·ªõp: "other"
    - ∆Øu ti√™n intent c·ª• th·ªÉ nh·∫•t, d·ª±a tr√™n t·ª´ kh√≥a trong tin nh·∫Øn.
    - Entity: Tr√≠ch xu·∫•t ch√≠nh x√°c t√™n s·∫£n ph·∫©m, h·ªó tr·ª£ nhi·ªÅu (v√≠ d·ª•: "iphone 14, samsung s23"). N·∫øu vi·∫øt t·∫Øt nh∆∞ "ip 14" th√¨ m·ªü r·ªông th√†nh "iphone 14".
    `;

    let parsed: ParsedIntent = { intent: 'other', entity: '', extra: { storage: '', color: '', priceRange: '', feature: '' } };
    try {
      const intentResult = await model.generateContent(intentPrompt);
      const jsonText = intentResult.response
        .text()
        .replace(/```json|```/g, '')
        .trim();
      parsed = JSON.parse(jsonText);
    } catch (error) {
      console.error('L·ªói parse intent:', error);
      parsed.intent = 'smalltalk';
    }

    // 6. X·ª≠ l√Ω smalltalk fallback t·ª´ AI
    if (parsed.intent === 'smalltalk') {
      console.log('[DEBUG] Intent l√† smalltalk t·ª´ AI.');
      return NextResponse.json({
        success: true,
        reply: 'Xin ch√†o Anh/Ch·ªã! Em l√† tr·ª£ l√Ω AI c·ªßa 7Teck. Anh/Ch·ªã mu·ªën t√¨m s·∫£n ph·∫©m n√†o h√¥m nay? ƒêi·ªán tho·∫°i, laptop hay m√°y t√≠nh b·∫£ng?',
        intent: parsed.intent,
        entity: parsed.entity,
        productsFound: 0,
        source: 'ai', // Th√™m field debug source
      });
    }

    // 7. K·∫øt h·ª£p entities t·ª´ regex v√† parsed
    if (parsed.entity) {
      entities = [...new Set([...entities, ...parsed.entity.split(',').map((e) => e.trim())])];
    }

    // 8. L·ªçc s·∫£n ph·∫©m v·ªõi th√¥ng tin parsed ƒë·∫ßy ƒë·ªß
    foundProducts = filterProducts(cachedData, entities, parsed.extra, parsed.intent);

    // 9. N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y v√† kh√¥ng ph·∫£i compare, fallback t√¨m ki·∫øm m·ªü r·ªông
    if (foundProducts.length === 0 && parsed.intent !== 'compare_products') {
      foundProducts = cachedData.filter((item) => queryMatchesName(parsed.entity.toLowerCase(), item.name)).slice(0, 5);
    }

    // 10. T·∫°o reply b·∫±ng Gemini, s·ª≠ d·ª•ng ki·∫øn th·ª©c c·∫≠p nh·∫≠t 2025
    console.log(`[DEBUG] G·ªçi AI (Gemini) ƒë·ªÉ t·∫°o reply d·ª±a tr√™n intent. T√¨m th·∫•y ${foundProducts.length} s·∫£n ph·∫©m t·ª´ DB (n·∫øu c√≥).`);
    const systemPrompt = `
    B·∫°n l√† ChatBot 7Teck, tr·ª£ l√Ω b√°n h√†ng chuy√™n nghi·ªáp, th√¢n thi·ªán t·∫°i 7Teck.vn - c·ª≠a h√†ng b√°n ƒëi·ªán tho·∫°i, laptop, m√°y t√≠nh b·∫£ng t√≠ch h·ª£p AI.
    ∆Øu ti√™n b√°n h√†ng: M√¥ t·∫£ s·∫£n ph·∫©m h·∫•p d·∫´n, nh·∫•n m·∫°nh t√≠nh nƒÉng, khuy·∫øn kh√≠ch mua, cung c·∫•p link chi ti·∫øt.
    S·ª≠ d·ª•ng HTML ƒë·ªÉ ƒë·ªãnh d·∫°ng: th·∫ª card cho s·∫£n ph·∫©m (kh√¥ng d√πng b·∫£ng ƒë·ªÉ tr√°nh tr√†n n·ªôi dung), v·ªõi class Tailwind, s·ª≠ d·ª•ng m√†u primary (#a92d30) cho text v√† border, primary-lighter (#fee2e2) cho background (v√≠ d·ª•: <div class="flex flex-col gap-4"> cho nhi·ªÅu card, m·ªói card: <div class="bg-primary-lighter border border-primary rounded-lg p-2 flex flex-col items-center text-center max-w-full overflow-hidden">, <img src="..." alt="..." class="w-16 h-16 object-contain mb-2 rounded">, <p class="text-primary font-bold text-sm truncate w-full">{t√™n}</p>, <p class="text-primary text-xs">M√†u: {m√†u}</p>, <p class="text-primary font-semibold text-sm">{gi√°} VNƒê</p>, <a href="..." class="text-primary text-xs hover:underline">Xem chi ti·∫øt</a>), s·ª≠ d·ª•ng truncate cho t√™n d√†i, object-contain cho ·∫£nh ƒë·ªÉ v·ª´a khung chat h·∫πp (400px), kh√¥ng th√™m text ngo√†i card ƒë·ªÉ tr√°nh v·ª° UI.
    Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn, h·ªØu √≠ch.
    N·∫øu kh√¥ng c√≥ s·∫£n ph·∫©m trong DB, s·ª≠ d·ª•ng ki·∫øn th·ª©c c·∫≠p nh·∫≠t c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m m·ªõi nh·∫•t nƒÉm 2025 (nh∆∞ iPhone 17 series v·ªõi gi√° t·ª´ 22 tri·ªáu VND cho b·∫£n ti√™u chu·∫©n, 42 tri·ªáu cho Pro, camera 24MP, ra m·∫Øt th√°ng 9/2025; Samsung Galaxy S25, iPad Air M3, MacBook Air M4, Windows laptops nh∆∞ Surface Laptop 7) ƒë·ªÉ g·ª£i √Ω, d·ª±a tr√™n d·ªØ li·ªáu web m·ªõi nh·∫•t, v√† g·ª£i √Ω t√¨m ki·∫øm th√™m ho·∫∑c li√™n h·ªá c·ª≠a h√†ng.
    ƒê·ªëi v·ªõi so s√°nh: Li·ªát k√™ ƒëi·ªÉm kh√°c bi·ªát, ∆∞u nh∆∞·ª£c ƒëi·ªÉm d·ª±a tr√™n ki·∫øn th·ª©c chung v√† d·ªØ li·ªáu m·ªõi nh·∫•t.
    ƒê·ªëi v·ªõi t√≠nh nƒÉng: S·ª≠ d·ª•ng ki·∫øn th·ª©c AI ƒë·ªÉ gi·∫£i th√≠ch chi ti·∫øt (camera, pin, hi·ªáu nƒÉng,...), khai th√°c th√¥ng tin b√™n ngo√†i n·∫øu c·∫ßn.
    N·∫øu intent l√† 'other' ho·∫∑c c√¢u h·ªèi kh√≥, s·ª≠ d·ª•ng ki·∫øn th·ª©c c·∫≠p nh·∫≠t ƒë·ªÉ tr·∫£ l·ªùi, v√≠ d·ª•: gi√° m·ªõi nh·∫•t, specs t·ª´ 2025.
    `;

    const userPrompt = `
    Intent c·ªßa ng∆∞·ªùi d√πng: ${parsed.intent}
    Entity: ${parsed.entity || entities.join(', ') || 'Kh√¥ng c√≥'}
    Extra: ${JSON.stringify(parsed.extra)}
    
    S·∫£n ph·∫©m t√¨m th·∫•y t·ª´ DB (∆∞u ti√™n hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng th·∫ª card HTML ƒë·∫πp n·∫øu ph√π h·ª£p, v·ªõi c·∫•u tr√∫c: H√¨nh ·∫£nh, T√™n (truncate), M√†u, Gi√° (ƒë·ªãnh d·∫°ng s·ªë ngh√¨n VNƒê, v√≠ d·ª•: 11.000.000 VNƒê), Link; kh√¥ng th√™m text ngo√†i card ƒë·ªÉ tr√°nh v·ª° UI):
    ${foundProducts.length > 0 ? JSON.stringify(foundProducts, null, 2) : 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m kh·ªõp. H√£y s·ª≠ d·ª•ng ki·∫øn th·ª©c c·∫≠p nh·∫≠t ƒë·ªÉ g·ª£i √Ω s·∫£n ph·∫©m t∆∞∆°ng t·ª± ho·∫∑c m·ªõi nh·∫•t t·ª´ 2025 d·ª±a tr√™n intent.'}
    
    Tin nh·∫Øn g·ªëc: "${message}"
    
    T·∫°o ph·∫£n h·ªìi ph√π h·ª£p v·ªõi intent:
    - ask_price: B√°o gi√° chi ti·∫øt, khuy·∫øn m√£i n·∫øu c√≥, c·∫≠p nh·∫≠t gi√° 2025 n·∫øu c·∫ßn.
    - search_product: Hi·ªÉn th·ªã th·∫ª card s·∫£n ph·∫©m ƒë·∫πp, m√¥ t·∫£ ng·∫Øn.
    - ask_color: Li·ªát k√™ m√†u s·∫Øc c√≥ s·∫µn cho s·∫£n ph·∫©m.
    - ask_payment: Gi·∫£i th√≠ch ch√≠nh s√°ch tr·∫£ g√≥p (0% l√£i, qua ng√¢n h√†ng,...).
    - ask_availability: X√°c nh·∫≠n c√≤n h√†ng (gi·∫£ s·ª≠ lu√¥n c√≥, ho·∫∑c h·ªèi th√™m).
    - compare_products: So s√°nh c√°c s·∫£n ph·∫©m t√¨m th·∫•y, s·ª≠ d·ª•ng specs m·ªõi nh·∫•t.
    - cheapest_product: Hi·ªÉn th·ªã s·∫£n ph·∫©m r·∫ª nh·∫•t, l√Ω do ch·ªçn.
    - filter_by_price: Li·ªát k√™ s·∫£n ph·∫©m trong kho·∫£ng gi√° d∆∞·ªõi d·∫°ng th·∫ª card.
    - filter_by_feature: G·ª£i √Ω s·∫£n ph·∫©m ph√π h·ª£p t√≠nh nƒÉng, gi·∫£i th√≠ch t·∫°i sao.
    - other: Tr·∫£ l·ªùi chung, ∆∞u ti√™n b√°n h√†ng, s·ª≠ d·ª•ng d·ªØ li·ªáu b√™n ngo√†i cho c√¢u h·ªèi kh√≥.
    `;

    const replyResult = await model.generateContent([systemPrompt, userPrompt]);
    const reply = replyResult.response.text();

    return NextResponse.json({
      success: true,
      reply: reply || 'Xin l·ªói, em kh√¥ng hi·ªÉu c√¢u h·ªèi. Anh/Ch·ªã c√≥ th·ªÉ m√¥ t·∫£ chi ti·∫øt h∆°n?',
      intent: parsed.intent,
      entity: parsed.entity || entities.join(', '),
      productsFound: foundProducts.length,
      source: 'ai', // Th√™m field debug source
    });
  } catch (err: unknown) {
    console.error('L·ªói server:', err);
    let errorMessage = 'L·ªói server, vui l√≤ng th·ª≠ l·∫°i.';
    if (err instanceof Error && 'response' in err && (err.response as { status: number }).status === 429) {
      errorMessage =
        'ƒê√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n s·ª≠ d·ª•ng API Gemini mi·ªÖn ph√≠ (50 y√™u c·∫ßu/ng√†y). Vui l√≤ng n√¢ng c·∫•p t√†i kho·∫£n Google AI Studio b·∫±ng c√°ch li√™n k·∫øt t√†i kho·∫£n thanh to√°n t·∫°i https://aistudio.google.com/app/apikey ƒë·ªÉ c√≥ h·∫°n m·ª©c cao h∆°n. Ho·∫∑c th·ª≠ l·∫°i v√†o ng√†y mai.';
    }
    return NextResponse.json({ success: false, message: errorMessage }, { status: 500 });
  }
}

export const dynamic = 'force-dynamic';
